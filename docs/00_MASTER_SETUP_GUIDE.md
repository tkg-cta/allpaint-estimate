作成日: 2025-12-15

# 本番環境構築・再現手順書

このドキュメントは、クライアントのGoogleアカウントおよびLINEアカウントを使用して、本システム（見積もり自動送信システム）をゼロから構築・再現するための完全な手順書です。

---

## 1. 事前準備
以下の情報・権限が必要です。
*   **Googleアカウント:** クライアントのGoogleアカウント（Gmail, Drive, Spreadsheet用）
*   **LINEアカウント:** LINE Developersコンソールへのログイン用
*   **GitHubアカウント:** ソースコードの管理・デプロイ用

---

## 2. Google Apps Script (GAS) の構築

### 2-1. スプレッドシートの作成
1.  Googleドライブで「新規」→「Google スプレッドシート」を作成します。
2.  シート名を `問い合わせ一覧` に変更します（重要）。
3.  スプレッドシートのURLから **ID** をコピーして控えておきます。
    *   URL例: `https://docs.google.com/spreadsheets/d/`**`1CjWPooxAf13bE0kD8HobvOXRseISoNBoINnyMdA_DdE`**`/edit`
    *   太字部分がIDです。

### 2-2. GASプロジェクトの作成
1.  スプレッドシートのメニューから「拡張機能」→「Apps Script」を開きます。
2.  エディタが開いたら、既存のコードを全て削除します。
3.  本リポジトリの `gas-script.js` の内容を全てコピーし、貼り付けます。
4.  プロジェクト名を「見積もりシステム」などに変更して保存します。

### 2-3. スクリプトプロパティの設定
**まだデプロイしないでください。** 先に環境変数を設定します。
1.  左側の歯車アイコン（プロジェクトの設定）をクリックします。
2.  一番下の「スクリプト プロパティ」までスクロールし、「スクリプト プロパティを追加」をクリックします。
3.  以下の4つのプロパティを追加します（値は後ほどLINE設定で取得しますが、枠だけ作っておきます）。

| プロパティ名 | 値 (仮) | 説明 |
| :--- | :--- | :--- |
| `SPREADSHEET_ID` | (先ほど控えたシートID) | 記録先シートのID |
| `LINE_ACCESS_TOKEN` | (後で入力) | LINE Messaging APIトークン |
| `LINE_USER_ID` | (後で入力) | 通知先管理者のLINE User ID |
| `LIFF_CHANNEL_ID` | (後で入力) | LIFFアプリのID |

---

## 3. LINE Developers設定

### 3-1. プロバイダーとチャネルの作成
1.  [LINE Developersコンソール](https://developers.line.biz/console/) にログインします。
2.  「新規プロバイダー作成」をクリックし、クライアント名（例: 株式会社〇〇）を入力します。
3.  「新規チャネル作成」→ **「Messaging API」** を選択します。
4.  必須項目（チャネル名、説明、業種など）を入力して作成します。

### 3-2. アクセストークンとUser IDの取得
1.  作成したチャネルの **「Messaging API設定」** タブを開きます。
2.  一番下の「チャネルアクセストークン（長期）」の発行ボタンを押し、発行されたトークンをコピーします。
    *   👉 GASの `LINE_ACCESS_TOKEN` プロパティに設定します。
3.  **「チャネル基本設定」** タブを開きます。
4.  「あなたのユーザーID」をコピーします。
    *   👉 GASの `LINE_USER_ID` プロパティに設定します。
    *   ※注意: クライアント本人のLINEに通知したい場合は、クライアントにこのチャネルを友だち追加してもらい、WebhookからIDを取得する仕組みが必要ですが、まずは開発者のIDでテストしてください。

### 3-3. LIFFアプリの作成
1.  同じプロバイダー内で「新規チャネル作成」→ **「LINE Login」** を選択します。
2.  作成後、**「LIFF」** タブを開き、「追加」をクリックします。
3.  **LIFFアプリ名:** 「見積もりフォーム」など
4.  **サイズ:** Full
5.  **エンドポイントURL:** (一旦ダミーで `https://google.com` と入力。後でGitHub PagesのURLに書き換えます)
6.  **Scopes:** `profile`, `openid` にチェックを入れます。
7.  作成後、表示される **LIFF ID** (例: `2008641975-xxxxxxx`) をコピーします。
    *   👉 GASの `LIFF_CHANNEL_ID` プロパティに設定します（**注意: ここにはLIFF IDではなく、LINE Loginチャネルの「チャネルID (数字のみ)」を設定する場合と、LIFF IDそのものを設定する場合がありますが、今回のコード `verifyLiffIdToken` では `client_id` として `LIFF_CHANNEL_ID` を使っています。LINE Loginチャネルの「チャネル基本設定」にある「チャネルID（10桁程度の数字）」を設定してください**）。

---

## 4. GASのデプロイ

1.  GASエディタに戻り、右上の「デプロイ」→「新しいデプロイ」をクリックします。
2.  **種類の選択:** 「ウェブアプリ」
3.  **説明:** 「Initial Deploy」
4.  **次のユーザーとして実行:** **「自分」** (重要)
5.  **アクセスできるユーザー:** **「全員」** (重要)
6.  「デプロイ」をクリックします。
7.  **「ウェブアプリのURL」** (`https://script.google.com/macros/s/.../exec`) が発行されるので、コピーします。

---

## 5. フロントエンド (React) の修正とデプロイ

### 5-1. コードの修正
ローカルのソースコード (`App.tsx`) を編集します。

1.  **LIFF IDの更新:**
    `App.tsx` 内の `LIFF_ID` 定数を、**3-3で取得した新しいLIFF ID** に書き換えます。
    ```javascript
    // App.tsx
    const LIFF_ID = "新しいLIFF_IDをここに貼り付け"; 
    ```

2.  **GAS URLの設定:**
    `.env` ファイル（またはGitHub Secrets）の `VITE_GAS_WEBHOOK_URL` を、**4で発行したGASウェブアプリURL** に書き換えます。

### 5-2. ビルドとデプロイ
1.  変更をGitにコミットし、GitHubにプッシュします。
2.  GitHub Actionsが自動的に動き、ビルドとデプロイが行われます。
3.  デプロイ完了後、発行されたURL（例: `https://username.github.io/repo-name/`）をコピーします。

---

## 6. 最終設定

1.  **LINE Developersに戻る:**
    LIFF設定のエンドポイントURLを、**5-2で発行された本番URL** に書き換えて保存します。

2.  **動作確認:**
    *   スマホのLINEからLIFF URLを開く、またはデプロイされたWebページを開きます。
    *   フォームを入力して送信します。
    *   **確認事項:**
        *   「送信完了」画面が出るか。
        *   スプレッドシートに行が追加されているか。
        *   管理者のLINEに通知が届くか。
        *   ユーザー（自分）のLINEに自動返信が届くか。

以上で構築は完了です。
