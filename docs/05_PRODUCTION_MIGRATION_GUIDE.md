作成日: 2025-12-08

# 本番環境（既存の店舗公式LINE）への移行ガイド

このドキュメントは、**すでに運用中の店舗公式LINEアカウント**に、全塗装シミュレーター機能を組み込むための手順書です。

> [!WARNING]
> **重要: 既存機能への影響確認**
> 店舗がすでに「Lステップ」や「他の自動応答ボット」を導入している場合、このシステムと競合する可能性があります。
> 導入前に、現在「Webhook」機能を使用しているか必ず確認してください。

---

## 1. 移行作業の全体像

1.  **Messaging API有効化**: 既存の公式アカウントでAPIを利用可能にする。
2.  **LIFF設定**: 店舗用のアカウントに紐付くLIFFアプリを作成する。
3.  **コード修正**: Reactアプリの `LIFF_ID` を書き換えてデプロイする。
4.  **GAS設定**: 店舗用のアクセストークンを設定し、Webhook URLを登録する。
5.  **リッチメニュー**: 既存のリッチメニューを差し替える（またはタブ分けする）。

---

## 2. 詳細手順

### Step 1: 既存アカウントでMessaging APIを有効にする

1.  [LINE Official Account Manager](https://manager.line.biz/) に、**店舗の管理者権限**を持つアカウントでログインします。
2.  対象の店舗アカウントを選択します。
3.  画面右上の「**設定**」→ 左メニューの「**Messaging API**」をクリックします。
4.  「**Messaging APIを利用する**」ボタンをクリックします。
5.  プロバイダー選択画面が出ます。
    -   既にプロバイダーがある場合: それを選択。
    -   ない場合: 新規作成（例: 「株式会社〇〇」など店舗の運営会社名）。
6.  入力内容を確認して有効化します。

### Step 2: LINE Developersでの設定 (LIFF & トークン)

1.  [LINE Developers Console](https://developers.line.biz/) にログインします。
2.  Step 1で選択/作成したプロバイダーを選択します。
3.  **Messaging APIチャネル**（店舗アカウント名）が表示されているはずなのでクリックします。

#### 2-1. アクセストークンの発行
1.  「**Messaging API設定**」タブを開きます。
2.  一番下の「チャネルアクセストークン（長期）」にある「**発行**」ボタンを押します。
3.  発行されたトークンをコピーしておきます（Step 4で使用）。

#### 2-2. LIFFチャネルの作成
1.  同じプロバイダー内で「**新規チャネル作成**」をクリックします。
2.  「**LINEログイン**」を選択して作成します。
    -   チャネル名: 「全塗装シミュレーター」など
    -   アプリタイプ: 「ウェブアプリ」
3.  作成後、「**LIFF**」タブを開き、「**追加**」をクリックします。
    -   サイズ: 「Full」または「Tall」
    -   エンドポイントURL: **本番環境のURL** (例: `https://yourdomain.com/estimate/`)
    -   Scope: `openid`, `profile` にチェック
    -   ボットリンク機能: `On (Normal)` ※ここで**店舗の公式アカウント**を選択して紐付けます。
4.  発行された **LIFF ID** をコピーしておきます（Step 3で使用）。

### Step 3: Reactアプリのコード修正 & デプロイ

`App.tsx` ファイルにある LIFF ID を、Step 2-2で発行した店舗用のIDに書き換えます。

```typescript
// App.tsx
const LIFF_ID = "ここに店舗用の新しいLIFF_ID";
```

書き換え後、ビルドしてエックスサーバーへアップロード（デプロイ）します。

### Step 4: GASの設定 & Webhook登録

#### 4-1. GASのプロパティ更新
1.  Google Apps Scriptのエディタを開きます。
2.  「プロジェクト設定」→「スクリプトプロパティ」で以下を更新します。
    -   `LINE_ACCESS_TOKEN`: Step 2-1で発行した店舗用のトークン
    -   `LINE_USER_ID`: (テスト用にあなたのID、または空欄でも可)
    -   `LIFF_CHANNEL_ID`: Step 2-2で発行したLIFF IDの「Channel ID」（※LIFF IDのハイフンの前の数字部分ではありません。LINE Developersの「チャネル基本設定」にある10桁程度の数字です）
    -   `SPREADSHEET_ID`: 顧客管理用スプレッドシートのID

#### 4-2. Webhook URLの設定 (重要)
1.  GASを「**新しいデプロイ**」でデプロイし、ウェブアプリURLをコピーします。
2.  LINE Developers Consoleの「Messaging API設定」タブに戻ります。
3.  「**Webhook URL**」の欄に、GASのURLを入力して「更新」→「検証」をクリックします。
    -   ※「成功」と出ればOKです。
4.  「**Webhookの利用**」スイッチを必ず **ON** にします。

> [!CAUTION]
> **注意**: すでに他のボットシステム（Lステップ等）のURLが入っている場合、上書きすると既存システムが動かなくなります。その場合は併用できないため、担当者と相談してください。

### Step 5: リッチメニューの設置

1.  [LINE Official Account Manager](https://manager.line.biz/) を開きます。
2.  「ホーム」→「トークルーム管理」→「リッチメニュー」を開きます。
3.  **現在稼働中のリッチメニューがある場合**:
    -   既存のデザインに「見積もりシミュレーション」ボタンを追加する等の画像修正が必要です。
    -   または、期間を指定して新しいメニューに切り替えます。
4.  ボタンのアクションに「**リンク**」を設定し、URLに `https://liff.line.me/{店舗用LIFF_ID}` を入力します。

---

## 3. AIへの作業指示プロンプト

将来、この作業を行う際に使用するプロンプトです。

```text
あなたはプロのエンジニアです。
現在、Reactで作られた「全塗装シミュレーター」を、**すでに運用中の店舗公式LINEアカウント**に導入しようとしています。

以下の手順に従って、私が作業を進められるようにサポートしてください。
特に、既存の運用（リッチメニューや他のボット）を壊さないように注意が必要です。

【移行に必要な情報】
1. 店舗用LIFF ID: (ここに取得したIDを入力)
2. 店舗用アクセストークン: (ここに取得したトークンを入力)
3. 本番環境のURL: (例: https://example.com/estimate/)
4. GASのウェブアプリURL: (ここにGASのURLを入力)

【現在の状況】
- 店舗アカウントですでにMessaging APIが有効か確認します。
- 既存のリッチメニューが設定されているか確認します。

まずは、LINE Official Account Managerでの現状確認からガイドをお願いします。
```
