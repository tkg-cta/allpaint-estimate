# 🐒 サルでもわかる！スプレッドシートCMSの仕組み

このドキュメントでは、「なぜスプレッドシートを書き換えるだけで、Webサイトの内容が変わるのか？」という仕組みを、できるだけ専門用語を使わずに解説します。

260113作成

---

## 1. 登場人物の紹介

この仕組みには、3人の登場人物がいます。

1.  **あなた（店長）** 👨‍🍳
    *   スプレッドシート（メニュー表）を書き換える人。
2.  **GAS（ガス / ウェイター）** 💁‍♂️
    *   Google Apps Scriptの略。
    *   あなたの代わりにスプレッドシートを見て、Webサイトに情報を運ぶ係。
3.  **Webサイト（お客さん）** 📱
    *   スマホやPCで見ている画面。

---

## 2. 全体の流れ

### ① あなたがメニューを変更する
あなたがスプレッドシート（`OptionsMaster` シート）に新しいオプションを追加したり、金額を変更したりします。
これは「**キッチンのメニュー表を書き換えた**」状態です。まだお客さん（Webサイト）には見えていません。

### ② Webサイトが「メニュー見せて！」と言う
お客さんがWebサイトを開くと、Webサイトは裏でこっそりGAS（ウェイター）に電話をかけます。
「**今の最新のメニュー教えて！**」

### ③ GASがスプレッドシートを見る
電話を受けたGASは、あなたが編集したスプレッドシートを見に行きます。
「**ふむふむ、新しいメニューが増えているな...**」

### ④ GASがWebサイトに教える
GASはスプレッドシートの内容を、Webサイトが理解できる言葉（JSONといいます）に翻訳して返事をします。
「**ほい、これが最新のメニューだよ！**」

### ⑤ Webサイトが表示する
WebサイトはGASから受け取ったデータを画面にきれいに並べて表示します。
これで、あなたがスプレッドシートに書いた内容が、Webサイトに反映されました！🎉

---

## 3. 重要なルール（ここだけ覚えて！）

この仕組みを壊さないために、いくつかルールがあります。

### ⚠️ ルール1：シートの名前を変えないで！
GASは **`OptionsMaster`** という名前のシートを探しています。
この名前を「オプション一覧」などに変えてしまうと、GASは「メニュー表がない！」とパニックになってしまいます。

### ⚠️ ルール2：列の並び順を変えないで！
GASは「A列はID、B列は名前...」という風に場所で覚えています。
列を入れ替えたり削除したりすると、金額のところに名前が表示されたりして大変なことになります。

### ⚠️ ルール3：カテゴリは決まった言葉で！
「カテゴリ」の列には、以下の4つのどれかを入れてください。
これ以外を入れると、Webサイトのどのタブにも表示されなくなります。

| 入力する言葉 | 意味 |
| :--- | :--- |
| `prep` | 下地処理・補修 |
| `parts` | 部品脱着 |
| `special` | 塗装・仕上げオプション |
| `coating` | コーティング・その他 |

### 🕒 おまけ：反映には時間がかかります
GASは働き者ですが、毎回スプレッドシートを見に行くと疲れてしまうので、**「10分間」は前の内容を覚えています（キャッシュといいます）。**
なので、スプレッドシートを書き換えても、Webサイトが変わるまで最大10分くらいかかることがあります。
「あれ？変わらないな？」と思っても、焦らずコーヒーでも飲んで待っていてください。☕️

---

## 4. もし壊れたら？（トラブルシューティング）

### Q. 画面に何も表示されなくなった！
*   スプレッドシートのシート名が `OptionsMaster` になっていますか？
*   GASのデプロイ（更新）をしましたか？

### Q. 金額がおかしい！
*   「価格」の列に、数字以外の文字（「円」とか「,」とか）が入っていませんか？
*   半角数字で入力してください。

### Q. 新しい項目が表示されない！
*   「カテゴリ」のスペルは合っていますか？（`prep`, `parts` など）
*   10分以上待ちましたか？

---

以上です！
スプレッドシートさえ正しく管理していれば、Webサイトのコードを触る必要はありません。

---

# 🔧 技術仕様書 (Technical Documentation)

ここからは、エンジニア向けの技術的な仕組みの解説です。

## 1. アーキテクチャ概要

本システムは、Google Sheetsを「ヘッドレスCMS」として利用する構成をとっています。

*   **Database**: Google Sheets (`OptionsMaster` シート)
*   **API Backend**: Google Apps Script (GAS)
*   **Frontend**: React + TypeScript (Vite)

### データフロー
1.  **Frontend**: `App.tsx` の `useEffect` で `fetch(GAS_URL + '?action=getOptions')` を実行。
2.  **Backend (GAS)**: `doGet(e)` 関数がリクエストを受信。
3.  **Cache Check**: `CacheService` を確認し、有効なキャッシュがあれば即座にJSONを返却（高速化 & Quota節約）。
4.  **Sheet Read**: キャッシュがない場合、`SpreadsheetApp` でシートにアクセスし、全データを取得。
5.  **Transformation**: 行データ（配列）をオブジェクトの配列に変換。ヘッダー行の日本語名をキー（`id`, `name`, `price` 等）にマッピング。
6.  **Response**: JSON文字列に変換し、`ContentService` を通じて返却。同時にキャッシュに保存（TTL: 10分）。

## 2. GASバックエンド詳細 (`gas-script.js`)

### エンドポイント
*   **Method**: `GET`
*   **Parameter**: `action=getOptions`
*   **Response Format**: JSON

### キャッシュ戦略
Google Sheets API (SpreadsheetApp) の読み込みは比較的低速（1〜2秒）であり、かつ大量のリクエストが来るとGoogleの制限（Quota）に引っかかるリスクがあります。
これを防ぐため、**GASの `CacheService` (ScriptCache)** を利用しています。

*   **Key**: `options_data_v1`
*   **TTL**: 600秒 (10分)
*   **Scope**: スクリプト全体（全ユーザーで共有）

### データマッピング
スプレッドシートの日本語ヘッダーを、以下の内部キーに変換しています。

```javascript
const keyMap = {
  'ID': 'id',
  'オプション名': 'name',
  '短い説明': 'description',
  '詳細説明': 'detailDescription',
  'カテゴリ': 'category',
  '料金タイプ': 'pricingType',
  '価格': 'price',
  '単位': 'unitLabel',
  '画像URL': 'image'
};
```

## 3. フロントエンド詳細 (`App.tsx`)

### データ取得ロジック
*   コンポーネントマウント時 (`useEffect`) に非同期でデータを取得。
*   取得中は `isLoadingOptions` ステートを `true` にし、ローディングスピナーを表示。
*   取得に失敗した場合（ネットワークエラーやGASのエラー）、`catch` ブロックでエラーログを出力し、**フォールバックデータ（`constants.ts` の `OPTIONS`）** を使用します（初期値として設定済み）。

### ステート管理
*   `optionsData`: 取得したオプション情報の配列。
*   `isLoadingOptions`: ローディング状態フラグ。

```typescript
// 初期値はフォールバックデータ
const [optionsData, setOptionsData] = useState<OptionItem[]>(OPTIONS);

// 取得成功時に上書き
const data = await response.json();
if (data.options) {
  setOptionsData(data.options);
}
```

## 4. セキュリティとCORS

*   **公開範囲**: GASウェブアプリは「全員（匿名ユーザーを含む）」としてデプロイされています。
*   **CORS**: GASの `ContentService` は自動的にCORSヘッダーを付与してリダイレクトするため、ブラウザからのクロスオリジンリクエストが可能です。
*   **読み取り専用**: `doGet` はデータの読み取りのみを行い、書き込み権限はありません。書き込みは `doPost` で行われますが、こちらはフォーム送信専用のロジックで保護されています。
