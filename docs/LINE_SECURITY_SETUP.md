# LINE専用セキュリティ機能 セットアップガイド

**対象**: 全塗装シミュレーター (allpaint-estimate)  
**最終更新**: 2025-12-12

## 概要

このガイドでは、LINE LIFF専用のセキュリティ機能(IDトークン検証・サーバー側レート制限)のセットアップ手順を説明します。

## 前提条件

- LINE Developersアカウント
- LIFFアプリが作成済み
- Google Apps Scriptがデプロイ済み
- スプレッドシートが作成済み

---

## セットアップ手順

### 1. LINE Channel IDの確認

1. [LINE Developers Console](https://developers.line.biz/console/)にアクセス
2. 該当するプロバイダーを選択
3. LIFFアプリのチャネルを選択
4. 「チャネル基本設定」タブを開く
5. **Channel ID**をコピー (例: `1234567890`)

### 2. GASスクリプトプロパティの設定

1. [Google Apps Script](https://script.google.com/)で該当プロジェクトを開く
2. 左メニューの⚙️「プロジェクトの設定」をクリック
3. 「スクリプトプロパティ」タブを選択
4. 「スクリプトプロパティを追加」をクリック
5. 以下のプロパティを追加:

| プロパティ | 値 | 説明 |
|-----------|---|------|
| `LIFF_CHANNEL_ID` | (上記で確認したChannel ID) | IDトークン検証に使用 |

**既存のプロパティ**:
- `LINE_ACCESS_TOKEN`: LINEチャネルアクセストークン (既存)
- `LINE_USER_ID`: 管理者のLINE UserID (既存)

### 3. スプレッドシートの準備

#### 自動作成の場合 (推奨)
初回送信時に自動的に「RateLimit」シートが作成されます。特別な操作は不要です。

#### 手動作成の場合
1. 該当するスプレッドシートを開く
2. 新しいシート「RateLimit」を作成
3. A1セルに「UserID」、B1セルに「LastSubmissionTime」と入力

### 4. GASスクリプトの更新とデプロイ

1. `gas-script.js`の内容をGASエディタに貼り付け
2. 「デプロイ」→「デプロイを管理」をクリック
3. 鉛筆アイコン(編集)をクリック
4. バージョン: 「新バージョン」を選択
5. 「デプロイ」をクリック

> [!IMPORTANT]
> URLは変更されません。既存のLIFFアプリの設定変更は不要です。

---

## 動作確認

### 1. ローカル開発環境での確認

```bash
npm run dev
```

ブラウザで`http://localhost:3000/`を開き、以下を確認:
- コンソールに「Local environment detected. Skipping LIFF init.」と表示
- モックトークンが使用される
- フォーム送信が正常に動作

### 2. LINE環境での確認

#### IDトークン検証のテスト

1. LINEアプリでLIFFを開く
2. フォームを入力して送信
3. GASの実行ログを確認:
   ```
   ✅ LINEセキュリティ: IDトークン検証成功
   ✅ レート制限: チェック通過
   ```

#### サーバー側レート制限のテスト

1. フォームを送信 (成功)
2. すぐに再度送信
3. 以下のエラーが表示されることを確認:
   ```
   Rate limit exceeded. Please wait XX seconds.
   ```
4. 60秒後に再度送信
5. 成功することを確認

---

## トラブルシューティング

### エラー: "Unauthorized: Missing authentication token"

**原因**: IDトークンが送信されていない

**対処法**:
1. LIFFアプリ内からアクセスしているか確認
2. ブラウザのコンソールで「ID Token retrieved successfully」が表示されるか確認
3. LIFF IDが正しいか確認

### エラー: "Unauthorized: Invalid authentication token"

**原因**: IDトークンの検証に失敗

**対処法**:
1. `LIFF_CHANNEL_ID`が正しく設定されているか確認
2. GASの実行ログで詳細なエラーメッセージを確認
3. LIFFアプリを再起動

### エラー: "LIFF_CHANNEL_ID not configured"

**原因**: スクリプトプロパティが未設定

**対処法**:
1. GASのプロジェクト設定を開く
2. スクリプトプロパティに`LIFF_CHANNEL_ID`を追加
3. GASを再デプロイ

### レート制限が機能しない

**原因**: RateLimitシートが作成されていない、またはエラー

**対処法**:
1. スプレッドシートに「RateLimit」シートが存在するか確認
2. GASの実行ログでエラーを確認
3. 手動でシートを作成 (A1: UserID, B1: LastSubmissionTime)

---

## セキュリティ上の注意事項

### 本番環境

✅ **実施すること**:
- LIFF Channel IDを正しく設定
- 定期的にアクセスログを確認
- 不審なアクティビティを監視

❌ **避けること**:
- Channel IDを公開リポジトリにコミット
- テスト用トークンを本番環境で使用
- レート制限を無効化

### ローカル開発環境

✅ **許可されること**:
- モックトークンの使用
- IDトークン検証のスキップ
- レート制限のスキップ

❌ **避けること**:
- 本番のChannel IDをローカル環境で使用
- モックトークンを本番環境で許可

---

## セキュリティレベル

### Before (基本セキュリティのみ)

```
⚠️ UserID偽装が可能
⚠️ レート制限回避が可能
⚠️ LIFF外部アクセスのリスク
```

### After (LINE専用セキュリティ実装後)

```
✅ IDトークンによるUserID検証
✅ サーバー側レート制限
✅ LINE公式APIによる正当性確認
✅ 多層防御の実現
```

---

## 関連ドキュメント

- [セキュリティドキュメント](./SECURITY.md)
- [GASセットアップガイド](./GAS_SETUP_GUIDE.md)
- [README](../README.md)

---

## サポート

問題が発生した場合は、以下を確認してください:

1. GASの実行ログ
2. ブラウザのコンソールログ
3. スプレッドシートのRateLimitシート
4. LINE Developersコンソールの設定
