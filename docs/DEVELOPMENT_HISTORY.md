作成日: 2025-12-08

# 全塗装シミュレーター開発・連携システム設定履歴

このドキュメントは、全塗装シミュレーターの開発からLINEリッチメニュー連携、およびトラブルシューティングまでの全工程をまとめたものです。

---

## 1. プロジェクト概要

### 目的
Reactで開発された「全塗装シミュレーター」をLINE公式アカウントと連携させ、ユーザーが見積もりを行った際に、**LINEユーザーID（userId）**を自動取得し、店舗への通知とユーザーへの自動応答を実現すること。

### 技術スタック
- **フロントエンド**: React + TypeScript + Vite
- **バックエンド**: Google Apps Script (GAS)
- **連携機能**: LINE Front-end Framework (LIFF), LINE Messaging API
- **ホスティング**: GitHub Pages (本番はエックスサーバー予定)

### データフロー
1.  ユーザーがLINEリッチメニューからシミュレーターを開く
2.  LIFFが起動し、LINEユーザーIDを取得
3.  ユーザーが見積もりフォームを送信
4.  ReactアプリがGASへデータをPOST（見積もり内容 + userId）
5.  GASが以下の処理を実行:
    -   スプレッドシートへの記録
    -   店舗へのメール通知
    -   管理者へのLINE通知
    -   **ユーザーへのLINE自動応答（Push通知）**

---

## 2. 開発・実装の全フロー (Zero to Hero)

### Phase 1: Reactアプリケーションの構築 (基盤)

まずは、Webブラウザ上で動作する見積もりシミュレーターをReactで構築しました。

#### **主な機能と構成**
1.  **ステップウィザード形式**:
    -   ユーザーが迷わないよう、1画面1質問の対話形式で進行 (`StepWizard.tsx`)。
    -   Step 1: 車両選択 (軽自動車 / 普通車 / 大型車)
    -   Step 2: 塗装タイプ選択 (ソリッド / メタリック / パールなど)
    -   Step 3: オプション選択 (部品脱着、下地処理など)
    -   Step 4: 見積もり確認
    -   Step 5: お客様情報入力 & 送信

2.  **リアルタイム価格計算**:
    -   `App.tsx` 内で状態管理 (`useState`) を行い、選択内容に応じて合計金額を即座に再計算 (`useMemo`)。
    -   車両サイズごとの価格差や、オプションの数量計算も自動化。

3.  **レスポンシブデザイン**:
    -   Tailwind CSSを使用し、PCでもスマホでも見やすいUIを実装。
    -   スマホユーザーを意識した大きめのボタンとカードデザイン。

### Phase 2: バックエンド連携 (GAS)

Reactアプリ単体ではメール送信ができないため、Google Apps Script (GAS) をバックエンドとして採用しました。

1.  **APIエンドポイントの作成**:
    -   GASで `doPost(e)` 関数を作成し、Webアプリとしてデプロイ。
    -   Reactから `fetch` でJSONデータをPOST送信する仕組みを構築。

2.  **スプレッドシート連携**:
    -   送信された見積もりデータをGoogleスプレッドシートに自動追記。
    -   顧客管理の台帳として機能。

3.  **管理者へのメール通知**:
    -   `GmailApp` を使用し、申し込みがあった瞬間に店舗へメール通知。

### Phase 3: LINE連携 (LIFF & Messaging API)

Webサイトとして公開するだけでなく、LINE公式アカウントのリッチメニューからシームレスに利用できるようにしました。

1.  **LIFF (LINE Front-end Framework) の導入**:
    -   `@line/liff` をReactにインストール。
    -   アプリ起動時に `liff.init()` を実行し、LINEユーザーID (`userId`) を取得。
    -   **強制ログイン**: LINE外（Chrome等）から開かれた場合は、LINEログイン画面へ誘導してIDを取得。

2.  **リッチメニューとの結合**:
    -   LINE公式アカウントのリッチメニューにLIFF URLを設定。
    -   タップするだけで、ログイン不要でシミュレーターが起動する体験を実現。

3.  **ユーザーへの自動応答 (Push通知)**:
    -   GAS側で `lineUserId` を受け取れるように改修。
    -   フォーム送信後、LINE Messaging APIを使って「お問い合わせありがとうございます」というメッセージをユーザーのLINEに直接返信。

---

## 3. 実装機能詳細 (React)

### コンポーネント構成
-   `App.tsx`: 全体の状態管理とルーティング（ステップ制御）。
-   `components/VehicleCard.tsx`: 車両選択カード。画像と基本料金を表示。
-   `components/PaintCard.tsx`: 塗装タイプ選択カード。
-   `components/OptionCard.tsx`: オプション選択。数量変更やON/OFF切り替え。
-   `constants.ts`: 価格マスタ。車両ごとの基本料金やオプション単価を一元管理。

### データの流れ
1.  **User Action**: 画面で選択 (車両、塗装、オプション)
2.  **State Update**: ReactのStateが更新される
3.  **Calculation**: `calculateTotal` が走り、合計金額が更新される
4.  **Submit**:
    -   `formData` (個人情報) + `quote` (見積もり内容) + `lineUserId` (LINE ID) をまとめる
    -   GASのエンドポイントへPOST送信

---

## 4. トラブルシューティングと解決策 (デバッグ報告)

---

## 3. トラブルシューティングと解決策 (デバッグ報告)

リッチメニュー連携時に発生した問題とその解決策です。

### 3.1. リッチメニューが表示されない
-   **現象**: 実機で確認してもリッチメニューが出てこない。
-   **原因**: 表示期間の「開始日時」が未来、または設定不備。
-   **解決**: OA Managerのリッチメニュー設定にて、表示期間の「開始日時」を**過去の時刻**に変更し、即時表示を有効化した。

### 3.2. LIFF認証エラー (400 Bad Request)
-   **現象**: リッチメニューをタップすると `400 Bad Request` エラーが発生。
-   **原因**: LINE Developers ConsoleでLIFFアプリのステータスが「**開発中**」のままで、一般公開が許可されていなかった。
-   **解決**: ステータスを「**公開**」に変更し、認証フローを有効化した。

---

## 4. 今後の運用・開発ガイドライン (MUST)

### 4.1. デプロイ時の必須確認事項
Reactアプリの公開URL（エンドポイント）を変更してデプロイする場合、**必ず**以下の対応を行ってください。

1.  **LINE Developers Console**: LIFF設定にある「エンドポイントURL」を、新しいURLと完全に一致させる。
2.  **更新忘れのリスク**: ここを更新しないと、再度 `400 Bad Request` が発生し、アプリが開けなくなります。

### 4.2. データ送信先の理解
-   顧客からのフォーム送信データは、LINEのチャット画面（1対1トーク）には届きません。
-   **GASで設定されたメールアドレス**（および管理者のLINE通知）に届きます。店舗担当者にはメール受信トレイを確認するよう周知してください。

### 4.3. コード実装の維持
-   `App.tsx` 内の `liff.getProfile()` による `userId` 取得ロジックは、連携の核となる部分です。
-   今後の改修時も、このロジックを削除・変更せず、GASへのPOSTデータに `lineUserId` を含める設計を維持してください。

---

## 5. 関連ファイル

-   **フロントエンド**: `App.tsx` (LIFF初期化、フォーム送信)
-   **バックエンド**: `gas-script.js` (メール送信、LINE通知、自動応答)
-   **設定**: `package.json` (`@line/liff` 依存関係)
