作成日: 2025-12-15

# システムレビュー・セキュリティ確認ガイド

他のエンジニアにレビューを依頼する際や、セキュリティチェックを行う際は、以下のファイルとポイントを確認してください。

## 1. 最重要: バックエンド (GAS)
**ファイル:** `gas-script.js`

このファイルがセキュリティの「要（かなめ）」です。脆弱性診断ではここを最優先で確認してください。

### 🛡️ セキュリティ・脆弱性チェックポイント
*   **認証 (Authentication):**
    *   **関数:** `verifyLiffIdToken`
    *   **確認点:** LINEからの `idToken` を検証し、なりすましを防いでいるか。`UrlFetchApp.fetch` が `POST` メソッドで LINE API (`https://api.line.me/oauth2/v2.1/verify`) を正しく呼び出しているか。
*   **DoS攻撃対策 (Rate Limiting):**
    *   **関数:** `checkServerRateLimit`
    *   **確認点:** 同一ユーザーからの連打（1分間に複数回）をスプレッドシートを使ってブロックしているか。
*   **入力値検証 (Input Validation):**
    *   **関数:** `doPost` 内の「緊急セキュリティ対策」ブロック
    *   **確認点:**
        *   必須項目チェック（`customer`, `quote` 等）
        *   文字数制限（異常に長い文字列による攻撃対策）
        *   型チェック（数値フィールドに文字列が入っていないか）

### 🐛 不具合調査・デバッグ
*   **ログ:** `Logger.log` が各処理（スプレッドシート記録、メール送信、LINE通知）の成功/失敗を出力しています。
*   **参照場所:** GAS管理画面の「実行数」タブで、失敗したリクエストのログを展開して確認します。

---

## 2. フロントエンド・セキュリティ
**ファイル:** `utils/security.ts`

### 🛡️ セキュリティ・脆弱性チェックポイント
*   **XSS対策 (Cross-Site Scripting):**
    *   **関数:** `sanitizeInput`, `sanitizeFormData`
    *   **確認点:** `DOMPurify` ライブラリを使用して、入力値から悪意あるスクリプトタグ（`<script>`など）を完全に除去しているか。
*   **バリデーション:**
    *   **関数:** `validateEmail`, `validatePhoneNumber` 等
    *   **確認点:** 正規表現を用いて、送信前に不正な形式のデータを弾いているか。

---

## 3. データフロー・統合
**ファイル:** `App.tsx`

### 🛡️ セキュリティ・脆弱性チェックポイント
*   **トークンハンドリング:**
    *   **関数:** `handleFinalSubmit`
    *   **確認点:** `liff.getIDToken()` で取得したトークンを、加工せずにそのままGASへ送信しているか。
*   **通信の安全性:**
    *   **確認点:** `fetch` 先のURL (`GAS_URL`) がHTTPSであり、環境変数で管理されているか。

---

## レビュアーへの申し送り事項
このシステムは**「LINE LIFF IDトークン」による認証**をセキュリティの核としています。
`gas-script.js` 内の `verifyLiffIdToken` が正常に機能している限り、外部からの不正なリクエスト（なりすまし）は拒否されます。
最も重要なのは **`gas-script.js` のロジックが変更されていないこと** です。
