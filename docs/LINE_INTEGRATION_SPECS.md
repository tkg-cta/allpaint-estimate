# LINE連携仕様書 (全塗装シミュレーター)
260113

本システムにおけるLINE公式アカウントとの連携仕様、データフロー、および設定要件を網羅的にまとめました。

## 1. 全体フロー概要

1.  **入口**: エンドユーザーがLINE公式アカウントの「リッチメニュー」から「お見積もり」ボタンをタップ。
2.  **起動**: LIFF (LINE Front-end Framework) ブラウザでシミュレーターが起動。
3.  **認証**: 起動時にユーザーのLINE UserIDとIDトークンをバックグラウンドで取得。
4.  **入力**: ユーザーが車両・塗装・オプションを選択し、お客様情報を入力。
5.  **送信**: フォーム送信時、見積もりデータと共にUserIDとIDトークンをGoogle Apps Script (GAS) へ送信。
6.  **処理**: GASがデータを受信・検証し、以下の3つのアクションを実行。
    *   **Googleスプレッドシート**: 顧客・見積もり情報の記録。
    *   **管理者への通知**: 店舗管理者（あなた）へLINEプッシュ通知＆メール送信。
    *   **ユーザーへの通知**: エンドユーザーへLINE自動返信メッセージを送信。
7.  **事後対応**: その後のやり取りは、LINE公式アカウントの「チャット機能」を用いて手動で行う。

---

## 2. LINE公式アカウント設定要件

本システムを正常に稼働させるための必須設定です。

| 設定項目 | 設定値 | 理由 |
| :--- | :--- | :--- |
| **応答モード** | **チャット** | 個別の手動返信（1:1トーク）を行うため必須。 |
| **Webhook** | **オフ** | GASは受信専用であり、チャットの受信（Webhook）は処理しないため。オンにすると手動チャットに支障が出る場合がある。 |
| **応答時間** | **オフ** | オンにすると、設定時間外に通知が届かなくなるため。24時間受信可能にするにはオフにする。 |
| **あいさつメッセージ** | **オン** (任意) | 友だち追加時の自動メッセージ。シミュレーターへの誘導URLを載せると効果的。 |

---

## 3. 技術仕様詳細

### A. フロントエンド (React/LIFF)
*   **LIFF ID**: `2008641975-j1OwPK6n`
*   **初期化処理**: アプリ起動時に `liff.init()` を実行。
*   **取得データ**:
    *   `userId`: ユーザー識別用（Uで始まる33桁の文字列）。
    *   `idToken`: なりすまし防止の認証用トークン。
*   **送信データ**: フォーム送信時に、見積もり内容と合わせて `userId` と `idToken` をGASへPOST送信。

### B. バックエンド (Google Apps Script)
*   **エンドポイント**: `doPost(e)` 関数がHTTP POSTを受け付けます。
*   **セキュリティ検証**:
    *   **IDトークン検証**: 送信された `idToken` をLINEの検証APIに投げ、正当なリクエストか確認。
    *   **レート制限**: 同一ユーザーからの連続送信を制限（60秒間隔）。
*   **通知送信 (Messaging API)**:
    *   `UrlFetchApp` を使用して `https://api.line.me/v2/bot/message/push` へリクエスト。
    *   **管理者通知**: スクリプトプロパティ `LINE_USER_ID` 宛に送信。
    *   **ユーザー通知**: フロントから受け取った `userId` 宛に送信。

---

## 4. メッセージ配信の仕様と制限

### A. 管理者への通知 (自分宛)
*   **仕組み**: Messaging APIの「プッシュメッセージ」を使用。
*   **消費数**: **1通消費します**。
*   **内容**: 顧客名、連絡先、車種、金額、オプションなどの概要。

### B. ユーザーへの自動返信 (お客様宛)
*   **仕組み**: Messaging APIの「プッシュメッセージ」を使用。
*   **消費数**: **1通消費します**。
*   **内容**: お礼メッセージ、見積もり内容の控え、来店希望日時の確認。

### C. 手動チャット (その後のやり取り)
*   **仕組み**: LINE Official Account Manager (Web/アプリ) のチャット機能を使用。
*   **消費数**: **消費しません (通数制限の対象外)**。
*   **通知**: スマホの「LINE公式アカウント」アプリ、またはPCブラウザで受信・返信。

> **⚠️ 重要: フリープランの制限**
> LINE公式アカウントのフリープランでは、Messaging APIによるメッセージ送信は **月間200通まで** です。
> シミュレーターが1回利用されると、「管理者通知(1) + ユーザー通知(1) = **2通**」消費します。
> つまり、**月間約100件の見積もり** が上限となります。これを超える場合は有料プランへのアップグレードが必要です。

---

## 5. 運用フロー (管理者向け)

1.  **通知の受信**:
    *   見積もりが来ると、「LINE公式アカウント」アプリではなく、**あなた個人のLINE**（`LINE_USER_ID`で設定したアカウント）に通知が届きます（GASからのBot通知）。
    *   同時にメールとスプレッドシートにも記録されます。

2.  **内容の確認**:
    *   届いた通知で概要を確認。詳細はスプレッドシートまたはメールで確認。

3.  **お客様への返信**:
    *   **「LINE公式アカウント」アプリ** を開く。
    *   「チャット」タブを開くと、お客様からのメッセージ（自動応答に対する返信などがあれば）や、履歴が見れます。
    *   ここから手動で「ご来店お待ちしております」などのメッセージを送ります。

## 6. よくあるトラブルと解決策

*   **「メッセージが届かない」**:
    *   **管理者通知**: GASの `LINE_USER_ID` 設定が間違っているか、ブロックしている可能性があります。
    *   **チャット通知**: 「LINE公式アカウント」アプリの通知設定、または「応答時間」設定を確認してください。
*   **「画面が真っ白になる」**:
    *   LINE内ブラウザのキャッシュが原因の場合が多いです。Chrome等の別ブラウザで開くか、キャッシュクリアを試してください。
*   **「送信エラーになる」**:
    *   LIFFの認証に失敗している可能性があります（PCで直接URLを開いた場合など）。必ずLINEアプリから開くようにしてください。
