# セキュリティ対策ドキュメント

**最終更新**: 2025-12-12  
**対象システム**: 全塗装シミュレーター (allpaint-estimate)

## 概要

このドキュメントは、全塗装シミュレーターアプリケーションに実装されているセキュリティ対策と、2025年12月11日に実施したセキュリティ評価の結果をまとめたものです。

## 実装済みセキュリティ対策

### 1. フロントエンド対策 (React/TypeScript)

#### 1.1 入力バリデーション

**実装場所**: `utils/security.ts`, `App.tsx`

すべてのユーザー入力に対して、クライアント側でバリデーションを実施しています。

| フィールド | 検証内容 |
|-----------|---------|
| お名前 | 1文字以上100文字以下 |
| ふりがな | ひらがなのみ、100文字以下 |
| 電話番号 | 日本の電話番号形式、20文字以下 |
| メールアドレス | RFC 5322準拠の形式、200文字以下 |
| お問い合わせ内容 | 2000文字以下 |

**検証関数**:
```typescript
- validateName(name: string): boolean
- validateFurigana(furigana: string): boolean
- validatePhoneNumber(phone: string): boolean
- validateEmail(email: string): boolean
- validateInquiry(inquiry: string): boolean
```

**UI/UX**:
- バリデーションエラーは赤色のボーダーとアイコン付きメッセージで表示
- 入力時にエラーが自動的にクリア
- フォーム送信前にすべてのフィールドを検証

#### 1.2 XSS (クロスサイトスクリプティング) 対策

**実装場所**: `utils/security.ts`  
**使用ライブラリ**: DOMPurify

すべてのユーザー入力をサニタイズし、悪意のあるスクリプトの実行を防止しています。

```typescript
export const sanitizeInput = (input: string): string => {
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: [],    // HTMLタグを一切許可しない
    ALLOWED_ATTR: [],    // 属性も許可しない
    KEEP_CONTENT: true,  // テキストコンテンツは保持
  });
};
```

**適用タイミング**: フォーム送信直前に全データをサニタイズ

#### 1.3 レート制限 (Rate Limiting)

**実装場所**: `utils/security.ts`, `App.tsx`  
**制限時間**: 60秒

連続送信を防止するため、LocalStorageを使用したクライアント側レート制限を実装しています。

**機能**:
- 送信成功後、60秒間は再送信不可
- 送信ボタンに残り時間をリアルタイム表示
- クールダウン中はボタンが無効化

```typescript
- checkRateLimit(): boolean
- recordSubmission(): void
- getRemainingCooldown(): number
```

---

### 2. バックエンド対策 (Google Apps Script)

**実装場所**: `gas-script.js`

#### 2.1 入力検証

GAS側でも多層防御として、以下の検証を実施しています。

1. **必須フィールドの存在チェック**
   - `customer`, `quote` オブジェクトの存在確認

2. **データ型チェック**
   - 各フィールドが期待される型であることを確認

3. **文字列長チェック**
   ```javascript
   - name: 100文字以下
   - email: 200文字以下
   - phone: 20文字以下
   - inquiry: 2000文字以下
   ```

4. **メールアドレス形式検証**
   ```javascript
   const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   ```

5. **金額の妥当性チェック**
   - 負の値を拒否
   - 異常に高額な値 (1000万円超) を拒否

6. **見積もり情報の完全性チェック**
   - 車両情報、塗装情報の存在確認

**エラーハンドリング**:
- バリデーションエラー時は400ステータスを返す
- エラーメッセージは詳細情報を含まない (情報漏洩防止)

#### 2.2 独立したエラーハンドリング

各処理 (スプレッドシート記録、メール送信、LINE通知) を個別の`try-catch`ブロックで囲み、一部の処理が失敗しても他の処理を継続できるようにしています。

---

## セキュリティ評価結果 (2025-12-11実施)

### 評価項目と対策状況

| # | 脆弱性 | 重要度 | 対策状況 | 備考 |
|---|--------|--------|---------|------|
| 1 | XSS (クロスサイトスクリプティング) | 高 | ✅ 対策済み | DOMPurifyによるサニタイゼーション |
| 2 | 入力検証不足 | 高 | ✅ 対策済み | フロントエンド・バックエンド両方で検証 |
| 3 | レート制限の欠如 | 中 | ✅ 対策済み | クライアント側で60秒制限 |
| 4 | CSRF (クロスサイトリクエストフォージェリ) | 中 | ⚠️ 部分対策 | GAS側の検証で緩和、トークンは未実装 |
| 5 | 情報漏洩リスク | 低 | ✅ 対策済み | エラーメッセージを抽象化 |

### 対策の優先順位

#### ✅ 実装済み (優先度: 高)
1. **XSS対策** - DOMPurifyによる完全なサニタイゼーション
2. **入力バリデーション** - フロントエンド・バックエンド両方で実施
3. **レート制限** - クライアント側で実装

#### ⚠️ 部分対策 (優先度: 中)
4. **CSRF対策** - 現状はGAS側の入力検証で緩和
   - 将来的な改善案: トークンベースの認証実装

#### 📋 今後の検討事項 (優先度: 低)
5. **サーバー側レート制限** - より堅牢な制限のため、GAS側での実装を検討
6. **セキュリティヘッダー** - デプロイ環境でのヘッダー設定

---

## 多層防御 (Defense in Depth) アプローチ

このアプリケーションでは、以下の多層防御戦略を採用しています:

```
┌─────────────────────────────────────┐
│  Layer 1: クライアント側バリデーション  │
│  - 入力形式チェック                    │
│  - 文字列長制限                       │
│  - リアルタイムエラー表示               │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  Layer 2: XSSサニタイゼーション        │
│  - DOMPurifyによる無害化              │
│  - HTMLタグ・スクリプト除去            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  Layer 3: レート制限                  │
│  - 60秒クールダウン                   │
│  - LocalStorage記録                  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  Layer 4: サーバー側検証 (GAS)        │
│  - データ型チェック                    │
│  - 金額妥当性チェック                  │
│  - 完全性チェック                     │
└─────────────────────────────────────┘
```

---

## 開発時のセキュリティベストプラクティス

### コーディング規約

1. **ユーザー入力を信頼しない**
   - すべての入力をバリデーション・サニタイズ
   - クライアント側の検証だけに依存しない

2. **エラーメッセージに注意**
   - 内部実装の詳細を露出しない
   - ユーザーフレンドリーかつ安全なメッセージ

3. **依存関係の管理**
   - `npm audit`で定期的に脆弱性チェック
   - セキュリティアップデートを適用

### デプロイ前チェックリスト

- [ ] すべての環境変数が正しく設定されている
- [ ] GASスクリプトプロパティ (LINE_ACCESS_TOKEN等) が設定済み
- [ ] バリデーション関数が正しく動作することを確認
- [ ] XSSテスト (`<script>alert('XSS')</script>`) で防御を確認
- [ ] レート制限が機能することを確認
- [ ] エラーハンドリングが適切に動作することを確認

---

## テスト方法

### 1. XSS対策のテスト

**手順**:
1. お問い合わせ内容に以下を入力:
   ```html
   <script>alert('XSS')</script>
   <img src=x onerror="alert('XSS')">
   ```
2. 確認画面で、スクリプトが実行されず、テキストとして表示されることを確認

**期待結果**: スクリプトタグが除去され、安全なテキストのみ表示

### 2. 入力バリデーションのテスト

| テストケース | 入力値 | 期待結果 |
|------------|-------|---------|
| 無効なメール | `invalid-email` | エラーメッセージ表示 |
| 無効な電話番号 | `123` | エラーメッセージ表示 |
| 漢字のふりがな | `山田太郎` | エラーメッセージ表示 |
| 長すぎる名前 | 101文字以上 | エラーメッセージ表示 |

### 3. レート制限のテスト

**手順**:
1. フォームを送信
2. 60秒以内に再度送信を試みる
3. 送信ボタンが無効化され、残り時間が表示されることを確認

**期待結果**: 60秒経過するまで再送信不可

---

## 今後の改善提案

### 短期 (1-3ヶ月)

1. **CSRF対策の強化**
   - トークンベースの認証実装
   - セッション管理の導入

2. **サーバー側レート制限**
   - GAS側でIPアドレスベースの制限
   - より堅牢なスパム対策

### 中期 (3-6ヶ月)

3. **セキュリティログの強化**
   - 不正なリクエストの記録
   - 異常検知アラート

4. **自動セキュリティテスト**
   - CI/CDパイプラインへの統合
   - 定期的な脆弱性スキャン

### 長期 (6ヶ月以上)

5. **WAF (Web Application Firewall) の導入**
   - より高度な攻撃からの保護

6. **セキュリティ監査**
   - 第三者による定期的な監査

---

## 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [DOMPurify Documentation](https://github.com/cure53/DOMPurify)
- [Google Apps Script Best Practices](https://developers.google.com/apps-script/guides/support/best-practices)

---

## 変更履歴

| 日付 | 変更内容 | 担当者 |
|-----|---------|-------|
| 2025-12-12 | 初版作成、セキュリティ対策実装 | AI Assistant |
| 2025-12-11 | セキュリティ評価実施 | AI Assistant |
