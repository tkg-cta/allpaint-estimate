# 全塗装シミュレーター開発・連携システム設定履歴

このドキュメントは、全塗装シミュレーターの開発からLINEリッチメニュー連携、およびトラブルシューティングまでの全工程をまとめたものです。

---

## 1. プロジェクト概要

### 目的
Reactで開発された「全塗装シミュレーター」をLINE公式アカウントと連携させ、ユーザーが見積もりを行った際に、**LINEユーザーID（userId）**を自動取得し、店舗への通知とユーザーへの自動応答を実現すること。

### 技術スタック
- **フロントエンド**: React + TypeScript + Vite
- **バックエンド**: Google Apps Script (GAS)
- **連携機能**: LINE Front-end Framework (LIFF), LINE Messaging API
- **ホスティング**: GitHub Pages (本番はエックスサーバー予定)

### データフロー
1.  ユーザーがLINEリッチメニューからシミュレーターを開く
2.  LIFFが起動し、LINEユーザーIDを取得
3.  ユーザーが見積もりフォームを送信
4.  ReactアプリがGASへデータをPOST（見積もり内容 + userId）
5.  GASが以下の処理を実行:
    -   スプレッドシートへの記録
    -   店舗へのメール通知
    -   管理者へのLINE通知
    -   **ユーザーへのLINE自動応答（Push通知）**

---

## 2. 開発・実装履歴

### Phase 1: 基本機能開発
-   Reactによる見積もりシミュレーターの実装（車両選択、塗装選択、オプション選択）。
-   Google Apps Script (GAS) によるメール送信APIの実装。

### Phase 2: LIFF連携の実装 (React側)
-   `@line/liff` パッケージの導入。
-   `App.tsx` にLIFF初期化ロジックを追加。
    -   **強制ログイン**: 未ログイン時（外部ブラウザ等）は `liff.login()` でLINEログイン画面へリダイレクト。
    -   **ローカル開発対応**: `localhost` ではLIFF初期化をスキップし、モックIDを使用するロジックを追加。

### Phase 3: 自動応答機能の実装 (GAS側)
-   `gas-script.js` の `doPost` 関数を拡張。
-   リクエストに含まれる `lineUserId` を使用し、LINE Messaging API経由でユーザーへ「お問い合わせありがとうございます」メッセージを自動送信する機能を追加。

### Phase 4: LINE公式アカウント・リッチメニュー連携
-   LINE Developers Consoleでのチャネル設定。
-   LINE Official Account Managerでのリッチメニュー作成とLIFF URLの設定。

---

## 3. トラブルシューティングと解決策 (デバッグ報告)

リッチメニュー連携時に発生した問題とその解決策です。

### 3.1. リッチメニューが表示されない
-   **現象**: 実機で確認してもリッチメニューが出てこない。
-   **原因**: 表示期間の「開始日時」が未来、または設定不備。
-   **解決**: OA Managerのリッチメニュー設定にて、表示期間の「開始日時」を**過去の時刻**に変更し、即時表示を有効化した。

### 3.2. LIFF認証エラー (400 Bad Request)
-   **現象**: リッチメニューをタップすると `400 Bad Request` エラーが発生。
-   **原因**: LINE Developers ConsoleでLIFFアプリのステータスが「**開発中**」のままで、一般公開が許可されていなかった。
-   **解決**: ステータスを「**公開**」に変更し、認証フローを有効化した。

---

## 4. 今後の運用・開発ガイドライン (MUST)

### 4.1. デプロイ時の必須確認事項
Reactアプリの公開URL（エンドポイント）を変更してデプロイする場合、**必ず**以下の対応を行ってください。

1.  **LINE Developers Console**: LIFF設定にある「エンドポイントURL」を、新しいURLと完全に一致させる。
2.  **更新忘れのリスク**: ここを更新しないと、再度 `400 Bad Request` が発生し、アプリが開けなくなります。

### 4.2. データ送信先の理解
-   顧客からのフォーム送信データは、LINEのチャット画面（1対1トーク）には届きません。
-   **GASで設定されたメールアドレス**（および管理者のLINE通知）に届きます。店舗担当者にはメール受信トレイを確認するよう周知してください。

### 4.3. コード実装の維持
-   `App.tsx` 内の `liff.getProfile()` による `userId` 取得ロジックは、連携の核となる部分です。
-   今後の改修時も、このロジックを削除・変更せず、GASへのPOSTデータに `lineUserId` を含める設計を維持してください。

---

## 5. 関連ファイル

-   **フロントエンド**: `App.tsx` (LIFF初期化、フォーム送信)
-   **バックエンド**: `gas-script.js` (メール送信、LINE通知、自動応答)
-   **設定**: `package.json` (`@line/liff` 依存関係)
